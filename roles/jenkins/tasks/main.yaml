---

# Creates a user for jenkins with the correct ssh key retrieved from the secrets
# repository
#
- name: create user for jenkins
  user: name=jenkins
    comment="Jenkins CI"
    home="/var/lib/jenkins"
    shell="/bin/bash"
  tags: ['jenkins']

- name: make sure /var/lib/jenkins/.ssh exists
  file: path=/var/lib/jenkins/.ssh
    owner=jenkins
    group=jenkins
    mode=0700
    state=directory
  tags: ['jenkins']

# We install a specific version of jenkins to avoid compability
# issues with plugins
#
- name: unlock jenkins version in yum
  lineinfile: dest=/etc/yum/pluginconf.d/versionlock.list
    state=absent
    regexp='^.:jenkins-.*'
  tags: ['jenkins', 'versionlock']

- name: Ensure jenkins is installed
  yum: name=jenkins-{{ env[inventory_file]['jenkins']['version']}}
    enablerepo=epel
    state=present
  register: jenkins_install
  tags: ['jenkins', 'versionlock']

- name: lock jenkins
  command: yum versionlock jenkins-{{env[inventory_file]['jenkins']['version']}}
  tags: ['jenkins', 'versionlock']

# configure jenkins to our liking
#
- name: Configure Jenkins Port
  sudo: yes
  when: port is defined
  lineinfile: dest=/etc/default/jenkins
    regexp=^HTTP_PORT=
    line=HTTP_PORT={{env[inventory_file]['jenkins']['port']}}
  tags: ['jenkins']

- name: Configure Jenkins Prefix
  sudo: yes
  when: prefix is defined
  lineinfile: dest=/etc/default/jenkins
    regexp=^PREFIX=
    line=PREFIX={{env[inventory_file]['jenkins']['prefix']}}
  tags: ['jenkins']

- name: Configure Jenkins E-mail
  sudo: yes
  when: email is defined
  template: src=hudson.tasks.Mailer.xml.j2
    dest={{env[inventory_file]['jenkins']['lib']}}/hudson.tasks.Mailer.xml
    owner=jenkins
    group=jenkins
    mode=0644
  tags: ['jenkins']

# Start jenkins, we need it up and running before we are able to download
# the CLI tool
- name: Ensure jenkins is running
  service: name=jenkins
    enabled=yes
    state=running
  tags: ['jenkins', 'initscripts']

# If Jenkins is installed or updated, wait for pulling the Jenkins CLI
# # wish there was a jenkins-cli rpm package
#
- name: "{{ startup_delay_s | default(90) }}s delay while starting Jenkins"
  wait_for: port={{env[inventory_file]['jenkins']['port']}}
    delay={{ startup_delay_s | default(90) }}
  when: jenkins_install.changed
  tags: ['jenkins']

# Create Jenkins CLI destination directory
- name: "Create Jenkins CLI destination directory"
  file: path={{ env[inventory_file]['jenkins']['dest'] }}
    state=directory
  sudo: yes
  tags: ['jenkins', 'jenkinscli']

# Get Jenkins CLI from localhost
- name: Get Jenkins CLI
  get_url: url=http://localhost:{{env[inventory_file]['jenkins']['port']}}/jnlpJars/jenkins-cli.jar
    dest={{env[inventory_file]['jenkins']['jenkinscli']}}
    mode=0440
  sudo: yes
  tags: ['jenkins', 'jenkinscli']

